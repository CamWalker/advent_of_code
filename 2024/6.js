const utils = require('../utils');

const sample = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`;

const inp = `..........##.....................................#............#........................#.....#........#...........#...............
...........#.............#.....#....................#...........#.#..............#.#......................................#.......
.#..............#...............................#.......#.#...................#...............#...............#..#...........#....
.#............................#.............................................................................#.#...................
...............#..........#............#...........................................#....#...#..........................#..........
..##.#..#......#.....................#..#......#................#..........................................#................#.....
.......#.....#...........................................#........#...............................#.#.............................
.........#...............#......#............#...................#...........#.........#..#...#...................................
#.....#.#....................................#.......................................................##..#...##..#..#.............
.............................#...#.......#...............................#.#...............#......................................
.....#................................#..........................#....................#...........................................
.......#............#..#................................................................................#..........#...#..........
...........#.............................................................#...............#................................#.....#.
.....................................................#.........#.....#..#.....#..................#.......#.....#...........#......
.#..........#................#..................#........#..............................................#....#..................#.
.....................#......#..........#...........#................#..#..#............................#...##.........#...........
.................#.....................................................................................#..........................
..........................#.....................................#.#..................................................#.#..........
............#....#........#...................................#...................................................#...............
............#........................#........##..............#....#.............#............#......#........#...................
....................#.#........#..........................#...........#.............#...............#.............##.......#......
...............................................#..................................#...................................#....##.....
...#.....#.......................................#..........#......................#.............#.............#.##.......#.......
........#......##...................................................................................#.............................
...#.................................#.....................................#......................................#.........#.....
....#.................#......#.........#.........................................................................#........#....#..
..........................#..#.......#............................##.............................................#.........##..#..
......................#......................................#......................#................#.........#..#...............
....#.....................................#...................#..............#..........................#...........#...#.........
...............#........#...............#..........#.....#..............................#....................................#.#..
......#......................#.......#.#...................#.............#...#.........#.....#....................................
.....#..#...............##....................................................#..#...#........................#..................#
......#.#..........#...#.................#...............#..........................................#...#.#.......................
..........#.......................................................................................................##..............
......................#..#...#......#.....................................................#.........#.........#...................
...................................................#...#.........#.....#......................#...............................#...
........................#...................................^..............................#.............#..........#...#.........
........#............................#.....................#......#...........##...........#......................................
..........#..................#........#...........................................................................................
.....#......................#.....#.............#....................#...............#...........##.......#..................##...
........#......................................#................................................#.....................#...........
......#.........#..............#.................................................................#.......##..#.#..................
........#......................................#...................#......................#.......................................
..#...............#....##.....#........................#.#.........#........#....#...................#.............#...#.........#
.............#..............#....#....#................#.....................................#...............#..................#.
..............#...........................................................................#..##..#...#.......#..........#.........
#...........#........................#..#......#..#.........#........#...#..............#............#.....#.................#...#
.....................#........................................#.................#.#..................#.............#.........#....
.............#.....................................................#.#....................................#.......................
.............#....#.............#.........................................................................#...........#...........
#.................#...#...#...............#..........#.........................##......#.....#..#.............................#...
#................#........#.......#.....#...............#..................................#.#.............................#......
.........#.......#.............#...................................................................................#..........#...
......#..............................................................................##............................#..........#...
..............#..................................................#...................................#..........................#.
.................................................................#.#...........#................#..........#..........#.......#.#.
...................................#.....................#..#...........................................................#.........
......................................................................................#.............#.............................
.....#......................................................................#......#....#.........#....#..#.......................
..................#.............................................................#.........................#.......................
......................#......#..........#..#............................#....#.........#.........#................................
..#...........#.......................#....#....................................#.......#.................................#.......
...................#.......................................................................................#..............#.......
.....#....................................#......#............#...##........#...............#......................#...........#..
......................................#.......................#.........#.#.........................................#.............
...#..............................................#................................................##...........................#.
.......................#.................................................................#.......................................#
.#...........#..#...................#.#......#................#......................................................#............
.......................................................................##..........#......#................#.......#.......#......
#..#...#...........................................#......#...............#.......................................................
....#.....#...........................#...........#...............##..............................................................
...#.......#.......................................................................................#............#.................
.............................................................................#...#.....................#...#......................
...................#.................................#.......#...........................#.....#.................................#
.........................................#........#....#.............#.............#...........................#..................
....#.....................................................................................#.#.#.......................#.#.........
..............................................................#..........#............................................#...........
.........#.#.............................#...#..........................#....................#....................................
......................................#.#......#..................................................................................
.................................................................................................................#................
..............#...................................................................................................................
...................................................#....................................................................##........
................#........................................#..............................................#...............#.........
.........#....#...#......#....................#.#.......................................#.............#.....#..............#....#.
.............................................................................................................##.....#..#..........
....#.............................#......#.....................................................#......................#.......#...
..#.................#........................#....#...##...................................#...............#......................
.........#..................................#.................#...#..#..........##................................................
......##.......................................................#...........#......................................................
......#..............................#...................##....#..................................................................
..................#.........#.................................................#.......#..................#........................
.........................#...........................................#.......#...........................................#........
............#.#...................#.#....#.................................#......##...........................................#..
..#....................#.....................#.........................#..............#.....#.........#...........................
..#............................................#.........................#....................#..................................#
...........................#......#...............................................................#......#..........#..........#..
.......................#.....#..................#...................................#.............#....#.....................#....
....................................................................#.....#....#..................................................
..#................#...#..........................................................................................................
.........................##.....#.................#.............#....................#...............#..............#......#.#....
.......................#...................##......................................#....#...............#........#.........#......
......#..#.........#............................................................#................................#......#.........
#........................#..................#...............................................#.#........#..........................
..........#................#...#.....................................................#............#...............................
............#................................................#.#...............#............#................................#....
..#............................................#....#....#.#.#................................#....................#..............
.........#...........................##.............#..#.................#........................#............................#..
..........................##......................#..............................#..................#.............................
.........#........#.......#..........#...........#.............................#...........................#.......#..............
..........................#................#......................................................................................
..........................#...............#..................#....................................#.........#....#..........#.....
..................#..#..................................................................#........#................................
##..#.......#..............#..#..............##.............#...#..#.........##.......................................#......#....
.............#.........#........#....................................................#................#.....#.....................
......#...................................#.....#................#..........................#.....................................
..#.......................#...#.#...#...........#..........#...................................#.............#.....#..............
..........#...#......................##...........................................................................................
....#............................#.#...................#....................#................#...........#..................#.....
.......#......#................#......................#......#........##..#....................#..................................
.......#..................#....#.....................................................................................#............
..................#......#................................#.........................#....#.............................#...#......
.................#.............#..........#....#.........................#..................................#.....##...........##.
............#..#............................................................................##...#.#....#....#.......##.#.......#.
......................#............................#.........#.....#.#.......##........................#..........................
...........#........................#..##........#....#.......#....#.#.....##.....................#.......#......#...............#
.................#...........#.......#..........#................................................#......................#.........
................#.......#.#.....................................................................................#.................
........................................#...#......#.......................................#...........#..........................
....#........##...............#...........#..................................................................#....................
#....................#...................#.........#....................................................................#.........`;

const directions = [
    [-1, 0],
    [0, 1],
    [1, 0],
    [0, -1],
]

function part1(input) {
    const visitedSpot = '$';
    const grid = Array.buildGrid(input, '\n', '');
    let nextSpace = [];
    grid.forEachGrid((v, y, x) => {
        if (v === '^') {
            nextSpace = [y, x];
        }
    });

    let directionIndex = 0;
    while(grid?.[nextSpace[0]]?.[nextSpace[1]]) {
        grid[nextSpace[0]][nextSpace[1]] = visitedSpot;
        let direction = directions[directionIndex];
        let potentialNextSpace = [nextSpace[0] + direction[0], nextSpace[1] + direction[1]];
        while(grid?.[potentialNextSpace[0]]?.[potentialNextSpace[1]] === '#') {
            directionIndex = (directionIndex + 1) % directions.length;
            direction = directions[directionIndex];
            potentialNextSpace = [nextSpace[0] + direction[0], nextSpace[1] + direction[1]];
        }
        
        nextSpace = potentialNextSpace;
    }

    let count = 0;
    grid.forEachGrid((v) => {
        if (v === visitedSpot) {
            count += 1;
        }
    })
	return count;
}

function part2(input) {
    const grid = Array.buildGrid(input, '\n', '');
    let nextSpace = [];
    grid.forEachGrid((v, y, x) => {
        if (v === '^') {
            nextSpace = [y, x];
        }
    });

    grid[nextSpace[0]][nextSpace[1]] = new Set();
    let directionIndex = 0;
    let count = new Set();
    while(grid?.[nextSpace[0]]?.[nextSpace[1]]) {
        if (grid[nextSpace[0]][nextSpace[1]] === '.') {
            grid[nextSpace[0]][nextSpace[1]] = new Set();
        }
        grid[nextSpace[0]][nextSpace[1]].add(directionIndex);
        let direction = directions[directionIndex];
        let potentialNextSpace = [nextSpace[0] + direction[0], nextSpace[1] + direction[1]];
        while(grid?.[potentialNextSpace[0]]?.[potentialNextSpace[1]] === '#') {
            directionIndex = (directionIndex + 1) % directions.length;
            direction = directions[directionIndex];
            potentialNextSpace = [nextSpace[0] + direction[0], nextSpace[1] + direction[1]];
        }
        
        
        // could this space be blocked to produce a loop?
        let hypotheticalDirectionIndex = (directionIndex + 1) % directions.length;
        let hypotheticalDirection = directions[hypotheticalDirectionIndex];
        let hypotheticalNextSpace = [nextSpace[0] + hypotheticalDirection[0], nextSpace[1] + hypotheticalDirection[1]];
        loopCheck: while(!['#', undefined].includes(grid?.[hypotheticalNextSpace[0]]?.[hypotheticalNextSpace[1]])) {
            const cell = grid?.[hypotheticalNextSpace[0]]?.[hypotheticalNextSpace[1]];
            if (cell instanceof Set && cell.has(hypotheticalDirectionIndex)) {
                count.add(`${hypotheticalNextSpace[0]}:${hypotheticalNextSpace[1]}`);
                break loopCheck;
            } else if (grid?.[hypotheticalNextSpace[0] + hypotheticalDirection[0]]?.[hypotheticalNextSpace[1] + hypotheticalDirection[1]] === '#') {
                hypotheticalDirectionIndex = (directionIndex + 1) % directions.length;
                hypotheticalDirection = directions[hypotheticalDirectionIndex];
            }
            hypotheticalNextSpace = [hypotheticalNextSpace[0] + hypotheticalDirection[0], hypotheticalNextSpace[1] + hypotheticalDirection[1]];
        }
        
        nextSpace = potentialNextSpace;
    }

	return count.size;
}

// const result = part1(inp);
// const result = part1(sample);
const result = part2(inp);
// const result = part2(sample);
// 6,4
// 6,6
// 7,6
// 8,2
console.log(result);